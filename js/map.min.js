jQuery.noConflict();
(function(l,D){var h=kintone.plugin.app.getConfig(D),k=window.GOOGLEMAPDEMO_COMMON||{},E=window.GOOGLEMAPDEMO_POLYGON||{},b=window.GOOGLEMAPDEMO_MAP||{};b.goodoro={appId:null,query:null,data:{viewId:null,shadesInfo:{}},getShadesInfo:function(){return this.data.shadesInfo[this.data.viewId]}};var y=null;b.getRecords=function(a){a=a||{};var d=a.app||b.goodoro.appId,c=a.filterCond,e=a.sortConds||["$id asc"],g=a.fields,f=a.data;f||(f={records:[],lastRecordId:0});a=[];c&&a.push(c);a.push("$id > "+f.lastRecordId);
var p=" order by "+e.join(", ")+" limit 500";a=a.join(" and ")+p;a={app:d,query:a};g&&0<g.length&&(-1>=g.indexOf("$id")&&g.push("$id"),a.fields=g);return kintone.api(kintone.api.url("/k/v1/records",!0),"GET",a).then(function(m){f.records=f.records.concat(m.records);if(500===m.records.length)return f.lastRecordId=m.records[m.records.length-1].$id.value,b.getRecords({app:d,filterCond:c,sortConds:e,fields:g,data:f});delete f.lastRecordId;return f.records})};b.load=function(a){var d=document.getElementsByTagName("head")[0],
c=document.createElement("script");c.type="text/javascript";c.src=a;d.appendChild(c)};b.waitLoaded=function(a,d,c){setTimeout(function(){var e=d-c;"undefined"!==typeof google&&"undefined"!==typeof google.maps&&"undefined"!==typeof google.maps.version?b.initialize(a):0<e&&b.waitLoaded(a,e,c)},c)};b.getColorCode=function(a){if(""!==a&&!isNaN(a))for(var d=parseInt(b.goodoro.getShadesInfo().shades.num,10),c=0;c<d;c++){var e=JSON.parse(b.goodoro.getShadesInfo().shades["row"+c]),g=parseFloat(e.threshold);
if(">="===e.operator&&a>=g)return e.fillColor}console.log("\u6761\u4ef6\u4e0d\u4e00\u81f4",a);return null};b.showListGraphicInfo=function(a){a=b.goodoro.query.substring(0,b.goodoro.query.indexOf("order by"));a={app:b.goodoro.appId,filterCond:a,sortConds:["$id asc"],fields:["$id",b.goodoro.getShadesInfo().fieldCode,h.governmentCode]};for(var d=Number(b.goodoro.getShadesInfo().info.num),c=0;c<d;c++){var e=JSON.parse(b.goodoro.getShadesInfo().info["row"+c]);a.fields.push(e.fieldCode)}var g=performance.now();
b.getRecords(a).then(function(f){for(var p=[],m={},w={},x=0;x<f.length;x++){var q=f[x],z=q[h.governmentCode].value;p.push(z);var A="";q[b.goodoro.getShadesInfo().fieldCode]&&!isNaN(q[b.goodoro.getShadesInfo().fieldCode].value)&&(A=parseFloat(q[b.goodoro.getShadesInfo().fieldCode].value));m[q[h.governmentCode].value]=b.getColorCode(A);w[z]=q}f={app:h.polygonMasterAppId,filterCond:k.DEF_GOVERNMENT_CODE+' in ("'+p.join('","')+'")',sortConds:["$id asc"],fields:["$id",k.DEF_GOVERNMENT_CODE,k.DEF_GRAPHIC_INFO_FIELD]};
return b.getRecords(f).then(function(t){var r=performance.now();console.log("get",r-g);for(r=0;r<t.length;r++){var n=t[r];if(n[k.DEF_GRAPHIC_INFO_FIELD].value){var F=JSON.parse(n[k.DEF_GRAPHIC_INFO_FIELD].value);n=n[k.DEF_GOVERNMENT_CODE].value;var B=m[n];if(B){var u={};u.recordId=w[n].$id.value;u.rowNum=d;for(var v=0;v<d;v++){var C=JSON.parse(b.goodoro.getShadesInfo().info["row"+v]);u["row"+v]={name:C.fieldName,value:w[n][C.fieldCode].value}}E.showList(y,F,B,u)}}}t=performance.now();console.log("load",
t-g);b.showShadesInfo()})})};b.showShadesInfo=function(){var a=l("<div>").addClass("overlay").css("height",h.mapHeight).appendTo(l("#map_canvas").children());a=l("<div>").addClass("scale").appendTo(a);for(var d=parseInt(b.goodoro.getShadesInfo().shades.num,10),c=0;c<d;c++){var e=JSON.parse(b.goodoro.getShadesInfo().shades["row"+c]),g=parseFloat(e.threshold);if(!isNaN(g)){var f=e.fillColor;e=parseInt(f.substring(1,3),16);var p=parseInt(f.substring(3,5),16);f=parseInt(f.substring(5,7),16);l("<div>").addClass("shades-color").css({"background-color":"rgba("+
e+", "+p+", "+f+", 0.9)"}).text(g+"\uff5e").appendTo(a)}}};b.getCurrentLocation=function(){return new kintone.Promise(function(a,d){var c={latitude:k.DEF_LOCATION.latitude,longitude:k.DEF_LOCATION.longitude};h.latitude&&h.longitude&&(c.latitude=h.latitude,c.longitude=h.longitude);return"1"===h.selectPosition?navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){c.latitude=e.coords.latitude;c.longitude=e.coords.longitude;return a(c)},function(e){console.error(e);switch(e.code){case e.POSITION_UNAVAILABLE:case e.PERMISSION_DENIED:alert("\u7aef\u672b\u306e\u8a2d\u5b9a\u3067\u4f4d\u7f6e\u60c5\u5831\u306e\u53d6\u5f97\u3092\u8a31\u53ef\u3057\u3066\u304f\u3060\u3055\u3044");
break;case e.PERMISSION_DENIED_TIMEOUT:alert("\u4f4d\u7f6e\u60c5\u5831\u304c\u53d6\u5f97\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002")}return a(c)}):(alert("\u4f4d\u7f6e\u60c5\u5831\u304c\u53d6\u5f97\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002"),a(c)):a(c)})};b.setCenterPosition=function(a,d){return new google.maps.LatLng(d.latitude,d.longitude)};b.initialize=function(a){new google.maps.MVCArray;b.getCurrentLocation().then(function(d){console.log(d);d=b.setCenterPosition(a,d);
d={zoom:parseInt(h.zoom,10),center:d,mapTypeId:google.maps.MapTypeId[h.mapType],draggableCursol:"crosshair"};var c=document.getElementById("map_canvas");y=new google.maps.Map(c,d);b.showListGraphicInfo(a)})};b.showGoogleMap=function(a,d){if("undefined"===typeof google||"undefined"===typeof google.maps||"undefined"===typeof google.maps.version){var c=l("<div>").attr("id","map_canvas").appendTo(d);c.attr("width","100%");c.height(h.mapHeight);var e=document.write;document.write=function(g){var f=g.match(/script.+src="([^"]+)"/);
f?b.load(f[1]):e(g)};b.load("https://maps.googleapis.com/maps/api/js?v=3&libraries=geometry&key="+h.apiKey);b.waitLoaded(a,1E4,100)}};b.checkDashboard=function(){"true"===k.getReqParam("dashboard")&&(l(".contents-actionmenu-gaia").css("display","none"),l(".contents-gaia.app-index-contents-gaia").css("display","none"),l(".contents-bottommenu-gaia").css("display","none"))};window.GOOGLEMAPDEMO_MAP=b})(jQuery,kintone.$PLUGIN_ID);